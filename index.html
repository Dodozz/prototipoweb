<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>El Regalo Perfecto ‚Äî POS + Inventario</title>
  <style>
    :root{
      --bg:#050817;--p:rgba(255,255,255,.06);--b:rgba(255,255,255,.10);
      --t:rgba(255,255,255,.92);--m:rgba(255,255,255,.62);--m2:rgba(255,255,255,.45);
      --ok:#34d399;--w:#fbbf24;--bad:#fb7185;--info:#38bdf8;
      --r:18px;--shadow:0 18px 60px rgba(0,0,0,.55)
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--t);background:
      radial-gradient(900px 500px at 15% 10%, rgba(255,255,255,.09), transparent 55%),
      radial-gradient(700px 500px at 85% 30%, rgba(56,189,248,.16), transparent 55%),
      radial-gradient(700px 600px at 60% 95%, rgba(251,113,133,.14), transparent 55%),
      linear-gradient(to bottom, rgba(2,6,23,.25), rgba(2,6,23,.95));}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 36px}
    .head{display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;align-items:flex-start}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:18px;display:grid;place-items:center;
      background:rgba(255,255,255,.10);border:1px solid var(--b);box-shadow:var(--shadow)}
    h1{margin:0;font-size:20px;font-weight:900;letter-spacing:-.02em}
    .sub{margin:4px 0 0;font-size:13px;color:var(--m)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--b);background:rgba(255,255,255,.05);color:var(--t);
      padding:10px 12px;border-radius:14px;font-weight:800;font-size:13px;cursor:pointer;transition:.15s}
    .btn:hover{background:rgba(255,255,255,.09);transform:translateY(-1px)}
    .btn:active{transform:none}
    .btn.primary{background:rgba(255,255,255,.92);color:#0b1020}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;
      border:1px solid var(--b);background:rgba(255,255,255,.06);font-size:12px;font-weight:900}
    .pill.ok{background:rgba(52,211,153,.12);border-color:rgba(52,211,153,.18);color:var(--ok)}
    .pill.w{background:rgba(251,191,36,.13);border-color:rgba(251,191,36,.18);color:var(--w)}
    .pill.bad{background:rgba(251,113,133,.13);border-color:rgba(251,113,133,.18);color:var(--bad)}
    .tabs{margin-top:14px;display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:6px;
      border-radius:18px;border:1px solid var(--b);background:rgba(255,255,255,.06);backdrop-filter:blur(10px)}
    .tab{border:1px solid transparent;background:transparent;color:var(--t);border-radius:14px;
      padding:10px 12px;text-align:left;cursor:pointer;transition:.15s}
    .tab:hover{background:rgba(255,255,255,.06)}
    .tab.on{background:rgba(255,255,255,.92);color:#0b1020}
    .t1{font-weight:900;font-size:13px}.t2{font-size:12px;opacity:.75}
    .row{margin-top:14px;display:grid;gap:14px}
    .row.pos,.row.rep{grid-template-columns:2fr 1fr}
    @media (max-width:980px){.row.pos,.row.rep{grid-template-columns:1fr}}
    .card{background:var(--p);border:1px solid var(--b);border-radius:22px;box-shadow:var(--shadow);
      backdrop-filter:blur(12px);overflow:hidden}
    .ch{padding:14px 16px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      border-bottom:1px solid var(--b)}
    .ch h2{margin:0;font-size:16px;font-weight:900}.ch p{margin:6px 0 0;font-size:13px;color:var(--m)}
    .cb{padding:16px}
    input,select{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--b);
      background:rgba(255,255,255,.05);color:var(--t);outline:none;font-size:13px}
    input::placeholder{color:rgba(255,255,255,.40)}
    .search{display:flex;gap:8px;align-items:center;min-width:260px}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}.search{min-width:100%}}
    .prod{border-radius:18px;border:1px solid var(--b);background:rgba(255,255,255,.05);padding:12px;
      cursor:pointer;transition:.15s;text-align:left}
    .prod:hover{background:rgba(255,255,255,.08);transform:translateY(-1px)}
    .prod:active{transform:none}
    .prod:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .top{display:flex;justify-content:space-between;gap:10px}
    .name{margin:0;font-weight:900;font-size:13px;line-height:1.25}
    .meta{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;color:var(--m);font-size:12px}
    .tag{padding:4px 8px;border-radius:10px;border:1px solid var(--b);background:rgba(255,255,255,.05);
      color:var(--t);font-weight:900;font-size:11px}
    .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1}
    .bot{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .line{border:1px solid var(--b);background:rgba(255,255,255,.05);border-radius:18px;padding:12px;display:grid;gap:10px}
    .lt{display:flex;justify-content:space-between;gap:10px}
    .qty{display:flex;gap:8px;align-items:center}
    .ib{width:34px;height:34px;border-radius:12px;border:1px solid var(--b);background:rgba(255,255,255,.05);
      cursor:pointer;display:grid;place-items:center;transition:.15s}
    .ib:hover{background:rgba(255,255,255,.09)}
    .tot{border:1px solid var(--b);background:rgba(255,255,255,.05);border-radius:18px;padding:12px}
    .tr{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .big{font-size:18px;font-weight:900}
    .pay{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .pb{border-radius:18px;padding:10px 12px;border:1px solid var(--b);background:rgba(255,255,255,.05);
      cursor:pointer;font-weight:900;transition:.15s}
    .pb.on{background:rgba(255,255,255,.92);color:#0b1020}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-top:1px solid var(--b);font-size:13px;text-align:left}
    thead th{border-top:none;background:rgba(255,255,255,.05);color:var(--m);font-size:12px;font-weight:900}
    .tw{border:1px solid var(--b);border-radius:18px;overflow:auto;background:rgba(255,255,255,.03)}
    .hide{display:none}
    .sep{height:1px;background:var(--b);margin:12px 0}
    /* modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;padding:16px;z-index:50}
    .modal.on{display:grid}
    .back{position:absolute;inset:0;background:rgba(0,0,0,.65)}
    .sheet{position:relative;width:min(760px,100%);border-radius:22px;border:1px solid var(--b);
      background:rgba(5,8,23,.82);box-shadow:0 30px 90px rgba(0,0,0,.65);backdrop-filter:blur(14px);overflow:hidden}
    .sh{padding:14px 16px;display:flex;justify-content:space-between;gap:10px;border-bottom:1px solid var(--b)}
    .sh h3{margin:0;font-size:16px;font-weight:900}.sh p{margin:6px 0 0;font-size:13px;color:var(--m)}
    .sb{padding:16px}.sf{padding:16px;border-top:1px solid var(--b);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .span2{grid-column:span 2}
    @media (max-width:640px){.form{grid-template-columns:1fr}.span2{grid-column:span 1}}
    /* toast */
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);width:min(560px,calc(100% - 32px));
      display:none;z-index:60}
    .toast.on{display:block}
    .tb{border:1px solid var(--b);background:rgba(5,8,23,.82);border-radius:18px;padding:12px 14px;
      box-shadow:var(--shadow);backdrop-filter:blur(12px);display:flex;gap:10px;align-items:flex-start}
    .dot{width:10px;height:10px;border-radius:999px;margin-top:4px}
    .dot.ok{background:var(--ok)}.dot.w{background:var(--w)}.dot.bad{background:var(--bad)}.dot.info{background:var(--info)}
    .tt{font-weight:900}.tm{font-size:13px;color:var(--m);margin-top:2px}
  </style>
</head>
<body>
<div class="wrap">
  <header class="head">
    <div class="brand">
      <div class="logo" aria-hidden="true">üéÅ</div>
      <div>
        <h1 id="storeName">El regalo perfecto, S.A.</h1>
        <p class="sub">Prototipo POS + Inventario + Reportes ‚Ä¢ sin instalaciones complicadas</p>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <span class="pill" id="stockPill">Cargando‚Ä¶</span>
          <span class="pill info" id="clerkPill">Caja 1</span>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="cfgBtn">‚öôÔ∏è Config</button>
      <button class="btn" id="invCsvBtn">‚¨áÔ∏è Inventario</button>
      <button class="btn" id="resetBtn">üîÑ Restablecer</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab on" id="tPos"><div><div class="t1">Punto de venta</div><div class="t2">Ventas y cobros</div></div></button>
    <button class="tab" id="tInv"><div><div class="t1">Inventario</div><div class="t2">Altas, bajas, stock</div></div></button>
    <button class="tab" id="tRep"><div><div class="t1">Reportes</div><div class="t2">Hoy, rango, ranking</div></div></button>
  </nav>

  <!-- POS -->
  <section class="row pos" id="vPos">
    <div class="card">
      <div class="ch">
        <div>
          <h2>Punto de venta</h2>
          <p>Selecciona art√≠culos, registra la venta y actualiza stock autom√°ticamente.</p>
        </div>
        <div class="search">
          <input id="posQ" placeholder="Buscar por SKU, nombre o categor√≠a"/>
          <button class="btn" id="focusBtn" title="Ctrl+K">‚åòK</button>
        </div>
      </div>
      <div class="cb">
        <div class="grid" id="prodGrid"></div>
        <div id="prodEmpty" class="hide" style="margin-top:14px;text-align:center;color:var(--m)">Sin resultados.</div>
      </div>
    </div>

    <div class="card">
      <div class="ch">
        <div>
          <h2>Carrito</h2>
          <p>Cobro en efectivo o tarjeta (validaciones incluidas).</p>
        </div>
        <span class="pill" id="cartPill">0 art√≠culos</span>
      </div>
      <div class="cb">
        <div id="cartLines" style="display:grid;gap:10px"></div>
        <div id="cartEmpty" class="tot" style="text-align:center;color:var(--m)">
          <div style="font-weight:900;margin-bottom:6px">Carrito vac√≠o</div>
          Agrega productos para registrar una venta.
          <div style="margin-top:10px;color:var(--m2);font-size:12px">Ctrl+K buscar ‚Ä¢ Ctrl+Enter cobrar</div>
        </div>

        <div style="margin-top:12px">
          <div class="tot">
            <div class="tr"><div style="color:var(--m);font-weight:900">Total</div><div class="big mono" id="tot">$0.00</div></div>
            <div class="tr" style="margin-top:6px;font-size:12px;color:var(--m)"><div>Utilidad</div><div class="mono" id="prof">$0.00</div></div>
          </div>

          <div class="pay">
            <button class="pb on" id="payCash">üíµ Efectivo</button>
            <button class="pb" id="payCard">üí≥ Tarjeta</button>
          </div>

          <div id="cashBox" style="margin-top:10px">
            <div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Efectivo recibido</div>
            <input id="cashGiven" type="number" placeholder="Monto recibido"/>
            <div style="margin-top:8px;display:flex;justify-content:space-between;color:var(--m);font-size:12px">
              <div>Cambio</div><div class="mono" id="change">$0.00</div>
            </div>
          </div>

          <div id="cardBox" class="hide" style="margin-top:10px">
            <div class="tot" style="color:var(--m)">Cobro con tarjeta seleccionado.</div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" id="clearBtn">Limpiar</button>
            <button class="btn primary" id="checkoutBtn">‚úÖ Cobrar</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- INVENTARIO -->
  <section class="row hide" id="vInv">
    <div class="card">
      <div class="ch">
        <div>
          <h2>Inventario</h2>
          <p>Regla de baja: desactivar solo si stock=0 y reposici√≥n=0.</p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="invQ" placeholder="Buscar producto" style="min-width:240px"/>
          <select id="invF" style="min-width:170px">
            <option value="all">Todos</option><option value="active">Activos</option>
            <option value="inactive">Inactivos</option><option value="low">Bajo stock</option>
          </select>
          <button class="btn" id="newBtn">‚ûï Nuevo</button>
        </div>
      </div>
      <div class="cb">
        <div class="tw">
          <table>
            <thead><tr>
              <th>SKU</th><th>Producto</th><th>Costo</th><th>Precio</th><th>Stock</th><th>Reorden</th><th>Estado</th><th>Acciones</th>
            </tr></thead>
            <tbody id="invBody"></tbody>
          </table>
        </div>
        <div id="invEmpty" class="hide" style="margin-top:14px;text-align:center;color:var(--m)">Sin resultados.</div>
        <div class="sep"></div>
        <span class="pill info">üìå RUF-09: baja permitida solo si stock=0 y reposici√≥n=0</span>
      </div>
    </div>
  </section>

  <!-- REPORTES -->
  <section class="row rep hide" id="vRep">
    <div class="card">
      <div class="ch">
        <div>
          <h2>Reportes</h2>
          <p>Ventas de hoy y por rango (export CSV).</p>
        </div>
        <button class="btn" id="rangeCsvBtn">‚¨áÔ∏è Exportar rango</button>
      </div>
      <div class="cb">
        <div class="form">
          <div><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Desde</div><input id="from" type="date"/></div>
          <div><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Hasta</div><input id="to" type="date"/></div>
        </div>
        <div class="sep"></div>
        <div class="form">
          <div class="tot"><div style="color:var(--m);font-weight:900;font-size:12px">Ventas</div><div class="big mono" id="rc">0</div></div>
          <div class="tot"><div style="color:var(--m);font-weight:900;font-size:12px">Art√≠culos</div><div class="big mono" id="ri">0</div></div>
          <div class="tot"><div style="color:var(--m);font-weight:900;font-size:12px">Ingresos</div><div class="big mono" id="rt">$0.00</div></div>
          <div class="tot"><div style="color:var(--m);font-weight:900;font-size:12px">Utilidad</div><div class="big mono" id="rp">$0.00</div></div>
        </div>
        <div class="sep"></div>
        <div class="tot">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div>
              <div style="font-weight:900">Ventas de hoy</div>
              <div style="color:var(--m2);font-size:12px" id="todayKey">‚Äî</div>
            </div>
            <button class="btn" id="todayCsvBtn">‚¨áÔ∏è Exportar hoy</button>
          </div>
          <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="tot"><div style="color:var(--m);font-weight:900;font-size:12px"># ventas</div><div class="big mono" id="tc">0</div></div>
            <div class="tot"><div style="color:var(--m);font-weight:900;font-size:12px">Total</div><div class="big mono" id="tt">$0.00</div></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="ch">
        <div><h2>Ranking por utilidad</h2><p>Top/Bottom 5 en el rango.</p></div>
      </div>
      <div class="cb">
        <div style="font-weight:900">üìà Top 5</div><div id="top" style="display:grid;gap:8px;margin-top:10px"></div>
        <div class="sep"></div>
        <div style="font-weight:900">üìâ Bottom 5</div><div id="bottom" style="display:grid;gap:8px;margin-top:10px"></div>
      </div>
    </div>
  </section>
</div>

<!-- MODAL PRODUCTO -->
<div class="modal" id="modal">
  <div class="back" id="mClose"></div>
  <div class="sheet">
    <div class="sh">
      <div><h3 id="mTitle">Producto</h3><p>Alta/edici√≥n de inventario.</p></div>
      <button class="btn" id="mX">‚úñ</button>
    </div>
    <div class="sb">
      <div class="form">
        <div><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">SKU</div><input id="fSku"/></div>
        <div><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Categor√≠a</div><input id="fCat"/></div>
        <div class="span2"><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Nombre</div><input id="fName"/></div>
        <div><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Costo</div><input id="fCost" type="number"/></div>
        <div><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Precio</div><input id="fPrice" type="number"/></div>
        <div><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Stock</div><input id="fStock" type="number"/></div>
        <div><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Reorden</div><input id="fReorder" type="number"/></div>
        <div class="span2" style="display:flex;gap:10px;align-items:center">
          <input id="fActive" type="checkbox" style="width:auto"/><label style="font-weight:900;font-size:13px">Activo (visible en ventas)</label>
        </div>
      </div>
    </div>
    <div class="sf">
      <button class="btn" id="mCancel">Cancelar</button>
      <button class="btn primary" id="mSave">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIG -->
<div class="modal" id="cfg">
  <div class="back" id="cClose"></div>
  <div class="sheet">
    <div class="sh">
      <div><h3>Configuraci√≥n</h3><p>Nombre de tienda y terminal.</p></div>
      <button class="btn" id="cX">‚úñ</button>
    </div>
    <div class="sb">
      <div class="form">
        <div class="span2"><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Tienda</div><input id="cStore"/></div>
        <div class="span2"><div style="color:var(--m);font-weight:900;font-size:12px;margin-bottom:6px">Cajero/Terminal</div><input id="cClerk"/></div>
      </div>
      <div class="sep"></div>
      <span class="pill info">Datos guardados localmente (localStorage).</span>
    </div>
    <div class="sf">
      <button class="btn" id="cCancel">Cerrar</button>
      <button class="btn primary" id="cSave">Guardar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="tb">
    <div class="dot info" id="dot"></div>
    <div style="flex:1">
      <div class="tt" id="tTitle">T√≠tulo</div>
      <div class="tm" id="tMsg">Mensaje</div>
    </div>
    <button class="btn" id="tX">‚úñ</button>
  </div>
</div>

<script>
  // ====== Estado + storage ======
  const LS_P="rp_p_v1", LS_S="rp_s_v1", LS_C="rp_c_v1";
  const demo=[
    {id:"sku-001",sku:"SKU-001",name:"Taza personalizada",cat:"Hogar",cost:55,price:149,stock:18,re:5,act:true},
    {id:"sku-002",sku:"SKU-002",name:"Caja de regalo premium",cat:"Empaque",cost:30,price:89,stock:40,re:10,act:true},
    {id:"sku-003",sku:"SKU-003",name:"Peluche mediano",cat:"Peluches",cost:90,price:219,stock:9,re:6,act:true},
    {id:"sku-004",sku:"SKU-004",name:"Tarjeta de felicitaci√≥n",cat:"Papeler√≠a",cost:6,price:25,stock:120,re:30,act:true},
    {id:"sku-005",sku:"SKU-005",name:"Vela arom√°tica",cat:"Hogar",cost:65,price:165,stock:0,re:8,act:true}
  ];
  const st={tab:"pos",q:"",pm:"cash",cart:[],edit:null,
    cfg:{store:"El regalo perfecto, S.A.", clerk:"Caja 1"},
    p:[], s:[]
  };
  const $=id=>document.getElementById(id);
  const money=n=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(Number(n||0));
  const dt=ts=>new Intl.DateTimeFormat("es-MX",{dateStyle:"medium",timeStyle:"short"}).format(new Date(ts));
  const todayKey=()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`};

  function load(){
    try{st.p=JSON.parse(localStorage.getItem(LS_P))||demo}catch{st.p=demo}
    try{st.s=JSON.parse(localStorage.getItem(LS_S))||[]}catch{st.s=[]}
    try{st.cfg=JSON.parse(localStorage.getItem(LS_C))||st.cfg}catch{}
  }
  function save(){
    localStorage.setItem(LS_P,JSON.stringify(st.p));
    localStorage.setItem(LS_S,JSON.stringify(st.s));
    localStorage.setItem(LS_C,JSON.stringify(st.cfg));
  }

  // ====== Toast ======
  function toast(kind,title,msg){
    $("tTitle").textContent=title; $("tMsg").textContent=msg;
    $("dot").className="dot "+(kind||"info");
    $("toast").classList.add("on");
    clearTimeout(toast._t); toast._t=setTimeout(()=>$("toast").classList.remove("on"),3200);
  }
  $("tX").onclick=()=>$("toast").classList.remove("on");

  // ====== Helpers ======
  const fp=id=>st.p.find(x=>x.id===id);
  const active=()=>st.p.filter(x=>x.act);
  const lowCount=()=>st.p.filter(x=>x.act && x.stock<= (x.re||0)).length;
  const lines=()=>st.cart.map(c=>{
    const p=fp(c.id); if(!p) return null;
    const unit=c.unit ?? p.price;
    return { ...c, p, unit, total:unit*c.qty, prof:(unit-p.cost)*c.qty };
  }).filter(Boolean);
  const totals=()=>{const L=lines();return{
    sub:L.reduce((a,l)=>a+l.total,0),
    prof:L.reduce((a,l)=>a+l.prof,0),
    items:L.reduce((a,l)=>a+l.qty,0)
  }};

  // ====== Tabs ======
  function setTab(t){
    st.tab=t;
    $("tPos").classList.toggle("on",t==="pos");
    $("tInv").classList.toggle("on",t==="inv");
    $("tRep").classList.toggle("on",t==="rep");
    $("vPos").classList.toggle("hide",t!=="pos");
    $("vInv").classList.toggle("hide",t!=="inv");
    $("vRep").classList.toggle("hide",t!=="rep");
    renderAll();
  }
  $("tPos").onclick=()=>setTab("pos");
  $("tInv").onclick=()=>setTab("inv");
  $("tRep").onclick=()=>setTab("rep");

  // ====== Render ======
  function renderHeader(){
    $("storeName").textContent=st.cfg.store;
    $("clerkPill").textContent=st.cfg.clerk;
    const n=lowCount();
    const el=$("stockPill");
    if(n>0){el.className="pill w"; el.textContent=`‚ö†Ô∏è ${n} bajo stock`;}
    else{el.className="pill ok"; el.textContent="‚úÖ Stock OK";}
  }

  function renderProducts(){
    const q=(st.q||"").trim().toLowerCase();
    const list=active().filter(p=>!q || `${p.sku} ${p.name} ${p.cat}`.toLowerCase().includes(q));
    $("prodGrid").innerHTML="";
    $("prodEmpty").classList.toggle("hide",list.length>0);
    list.forEach(p=>{
      const low=p.stock<= (p.re||0), out=p.stock<=0;
      const b=document.createElement("button");
      b.className="prod"; b.disabled=out;
      b.innerHTML=`
        <div class="top">
          <div style="min-width:0">
            <p class="name">${p.name}</p>
            <div class="meta"><span class="tag">${p.sku}</span><span>${p.cat}</span></div>
          </div>
          <div style="text-align:right">
            <div class="mono" style="font-weight:900">${money(p.price)}</div>
            <div style="margin-top:4px;font-size:12px;color:var(--m)">Utilidad: ${money(p.price-p.cost)}</div>
          </div>
        </div>
        <div class="bot">
          <span class="pill ${out?"bad":(low?"w":"ok")}">${out?"Sin stock":(low?"Bajo stock":"Disponible")}</span>
          <span style="font-size:12px;color:var(--m)" class="mono">Stock: ${p.stock}</span>
        </div>`;
      b.onclick=()=>addToCart(p.id);
      $("prodGrid").appendChild(b);
    });
  }

  function renderCart(){
    const L=lines(), T=totals();
    $("cartPill").textContent=`${T.items} art√≠culos`;
    $("tot").textContent=money(T.sub);
    $("prof").textContent=money(T.prof);

    $("cartLines").innerHTML="";
    $("cartEmpty").classList.toggle("hide", L.length>0);

    L.forEach(l=>{
      const el=document.createElement("div");
      el.className="line";
      el.innerHTML=`
        <div class="lt">
          <div style="min-width:0">
            <div style="font-weight:900">${l.p.name}</div>
            <div style="margin-top:4px;font-size:12px;color:var(--m)">${l.p.sku} ‚Ä¢ ${money(l.unit)} c/u</div>
          </div>
          <button class="ib" title="Eliminar">üóëÔ∏è</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div class="qty">
            <button class="ib" title="-1">‚ûñ</button>
            <div class="mono" style="min-width:34px;text-align:center;font-weight:900">${l.qty}</div>
            <button class="ib" title="+1">‚ûï</button>
          </div>
          <div style="text-align:right">
            <div class="mono" style="font-weight:900">${money(l.total)}</div>
            <div style="margin-top:4px;font-size:12px;color:var(--m)">Utilidad: ${money(l.prof)}</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--m)">Stock disponible: ${l.p.stock}</div>`;
      const btnTrash=el.querySelectorAll(".ib")[0];
      const btnMinus=el.querySelectorAll(".ib")[1];
      const btnPlus=el.querySelectorAll(".ib")[2];
      btnTrash.onclick=()=>removeLine(l.id);
      btnMinus.onclick=()=>setQty(l.id, l.qty-1);
      btnPlus.onclick=()=>setQty(l.id, l.qty+1);
      $("cartLines").appendChild(el);
    });

    // payment
    $("payCash").classList.toggle("on", st.pm==="cash");
    $("payCard").classList.toggle("on", st.pm==="card");
    $("cashBox").classList.toggle("hide", st.pm!=="cash");
    $("cardBox").classList.toggle("hide", st.pm!=="card");

    const given=Number($("cashGiven").value||0);
    const ch= st.pm==="cash" ? (given - T.sub) : 0;
    $("change").textContent=money(ch);
    $("change").style.color= ch<0 ? "var(--bad)" : "";
  }

  function renderInv(){
    const q=($("invQ").value||"").trim().toLowerCase();
    const f=$("invF").value;
    let list=[...st.p];
    if(f==="active") list=list.filter(x=>x.act);
    if(f==="inactive") list=list.filter(x=>!x.act);
    if(f==="low") list=list.filter(x=>x.act && x.stock <= (x.re||0));
    if(q) list=list.filter(x=>`${x.sku} ${x.name} ${x.cat}`.toLowerCase().includes(q));
    $("invBody").innerHTML="";
    $("invEmpty").classList.toggle("hide", list.length>0);

    list.forEach(p=>{
      const low=p.act && p.stock <= (p.re||0);
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><span class="tag">${p.sku}</span></td>
        <td><div style="font-weight:900">${p.name}</div><div style="font-size:12px;color:var(--m)">Utilidad: ${money(p.price-p.cost)}</div></td>
        <td class="mono">${money(p.cost)}</td>
        <td class="mono">${money(p.price)}</td>
        <td>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="ib" title="-1">‚ûñ</button>
            <div class="mono" style="min-width:34px;text-align:center;font-weight:900">${p.stock}</div>
            <button class="ib" title="+1">‚ûï</button>
          </div>
        </td>
        <td class="mono">${p.re}</td>
        <td>${p.act ? `<span class="pill ${low?"w":"ok"}">${low?"Alerta":"Activo"}</span>` : `<span class="pill">Inactivo</span>`}</td>
        <td>
          <button class="btn" data-a="e">Editar</button>
          <button class="btn" data-a="d">Desactivar</button>
        </td>`;
      tr.querySelectorAll(".ib")[0].onclick=()=>adj(p.id,-1);
      tr.querySelectorAll(".ib")[1].onclick=()=>adj(p.id,+1);
      tr.querySelector('[data-a="e"]').onclick=()=>openProd(p.id);
      tr.querySelector('[data-a="d"]').onclick=()=>deact(p.id);
      $("invBody").appendChild(tr);
    });
  }

  function renderRep(){
    // today
    const key=todayKey(); $("todayKey").textContent=key;
    const start=new Date(key).getTime(), end=start+86400000-1;
    const today=st.s.filter(x=>x.at>=start && x.at<=end);
    $("tc").textContent=String(today.length);
    $("tt").textContent=money(today.reduce((a,x)=>a+x.sub,0));

    // range
    const f=$("from").value ? new Date($("from").value).getTime() : null;
    const t=$("to").value ? (new Date($("to").value).getTime()+86400000-1) : null;
    const list=st.s.filter(x=>{
      if(f!=null && x.at<f) return false;
      if(t!=null && x.at>t) return false;
      return true;
    });
    const total=list.reduce((a,x)=>a+x.sub,0);
    const prof=list.reduce((a,x)=>a+x.prof,0);
    const count=list.length;
    const items=list.reduce((a,x)=>a + x.items.reduce((b,it)=>b+it.qty,0),0);
    $("rc").textContent=String(count);
    $("ri").textContent=String(items);
    $("rt").textContent=money(total);
    $("rp").textContent=money(prof);

    // ranking
    const agg=new Map();
    list.forEach(s=>s.items.forEach(it=>{
      const prev=agg.get(it.id)||{qty:0,prof:0};
      agg.set(it.id,{qty:prev.qty+it.qty,prof:prev.prof+it.prof});
    }));
    const rows=[...agg.entries()].map(([id,v])=>{
      const p=fp(id); return {name:p?.name||"Producto", sku:p?.sku||"‚Äî", qty:v.qty, prof:v.prof};
    });
    const top=rows.slice().sort((a,b)=>b.prof-a.prof).slice(0,5);
    const bot=rows.slice().sort((a,b)=>a.prof-b.prof).slice(0,5);
    const mk=(r,tone)=>`<div class="line"><div class="lt">
      <div style="min-width:0"><div style="font-weight:900">${r.name}</div>
      <div style="margin-top:4px;font-size:12px;color:var(--m)">${r.sku} ‚Ä¢ ${r.qty} uds</div></div>
      <span class="pill ${tone}">${money(r.prof)}</span></div></div>`;
    $("top").innerHTML= top.length? top.map(r=>mk(r,"ok")).join("") : `<div style="color:var(--m)">Sin datos.</div>`;
    $("bottom").innerHTML= bot.length? bot.map(r=>mk(r,"w")).join("") : `<div style="color:var(--m)">Sin datos.</div>`;
  }

  function renderAll(){ renderHeader(); renderProducts(); renderCart(); renderInv(); renderRep(); save(); }

  // ====== POS actions ======
  function addToCart(id){
    const p=fp(id);
    if(!p||!p.act){toast("w","Producto inactivo","Act√≠valo para venderlo.");return;}
    if(p.stock<=0){toast("bad","Sin stock","No hay existencias.");return;}
    const line=st.cart.find(x=>x.id===id);
    if(line){
      if(line.qty+1>p.stock){toast("w","Stock insuficiente",`Solo hay ${p.stock}.`);return;}
      line.qty++;
    }else st.cart.push({id,qty:1,unit:p.price});
    renderAll();
  }
  function setQty(id,qty){
    const p=fp(id); if(!p) return;
    qty=Math.max(1,Math.min(qty,p.stock));
    const l=st.cart.find(x=>x.id===id); if(!l) return;
    l.qty=qty; renderAll();
  }
  function removeLine(id){ st.cart=st.cart.filter(x=>x.id!==id); renderAll(); }
  function clearCart(){ st.cart=[]; $("cashGiven").value=""; st.pm="cash"; renderAll(); }

  function checkout(){
    const L=lines(); if(!L.length){toast("w","Carrito vac√≠o","Agrega productos.");return;}
    for(const l of L){ if(l.qty>l.p.stock){toast("bad","Stock cambi√≥",`${l.p.name} tiene ${l.p.stock}.`);return;}}
    const T=totals();
    if(st.pm==="cash"){
      const given=Number($("cashGiven").value||0);
      if(!Number.isFinite(given)||given<T.sub){toast("w","Efectivo insuficiente","Ingresa monto recibido.");return;}
    }
    const given= st.pm==="cash" ? Number($("cashGiven").value||0) : null;
    const change= st.pm==="cash" ? (given - T.sub) : null;

    // descontar stock
    L.forEach(l=>{ const p=fp(l.id); if(p) p.stock=Math.max(0,p.stock-l.qty); });

    // registrar venta
    const sale={
      id:(crypto?.randomUUID?.()||("sale_"+Date.now())),
      at:Date.now(), clerk:st.cfg.clerk, method:st.pm,
      items:L.map(l=>({id:l.id,sku:l.p.sku,name:l.p.name,qty:l.qty,unit:l.unit,total:l.total,prof:l.prof})),
      sub:T.sub, prof:T.prof, given, change
    };
    st.s.unshift(sale);
    toast("ok","Venta registrada",`Total: ${money(sale.sub)}${st.pm==="cash"?" ‚Ä¢ Cambio: "+money(sale.change):" ‚Ä¢ Tarjeta"}`);
    clearCart();
  }

  // ====== Inventario actions ======
  function adj(id,delta){ const p=fp(id); if(!p) return; p.stock=Math.max(0,(p.stock||0)+delta); renderAll(); }
  function deact(id){
    const p=fp(id); if(!p) return;
    if((p.stock||0)===0 && (p.re||0)===0){ p.act=false; toast("ok","Producto desactivado","Se ocultar√° en ventas."); }
    else toast("w","No cumple RUF-09","Solo si stock=0 y reposici√≥n=0.");
    renderAll();
  }

  // ====== Modal producto ======
  function openProd(id){
    st.edit=id||"new";
    const isNew=st.edit==="new";
    $("mTitle").textContent=isNew?"Nuevo producto":"Editar producto";
    const p=isNew?{id:"sku-"+Math.random().toString(10).slice(2,5),sku:"SKU-"+Math.random().toString(10).slice(2,5),
      name:"",cat:"General",cost:0,price:0,stock:0,re:0,act:true}:{...fp(id)};
    $("modal").dataset.buf=JSON.stringify(p);
    $("fSku").value=p.sku; $("fCat").value=p.cat; $("fName").value=p.name;
    $("fCost").value=p.cost; $("fPrice").value=p.price; $("fStock").value=p.stock; $("fReorder").value=p.re;
    $("fActive").checked=!!p.act;
    $("modal").classList.add("on");
  }
  function closeProd(){ $("modal").classList.remove("on"); st.edit=null; }
  function saveProd(){
    const buf=JSON.parse($("modal").dataset.buf||"{}");
    const p={...buf,
      sku:$("fSku").value.trim(), cat:$("fCat").value.trim()||"General", name:$("fName").value.trim(),
      cost:Number($("fCost").value||0), price:Number($("fPrice").value||0),
      stock:Math.max(0,Number($("fStock").value||0)), re:Math.max(0,Number($("fReorder").value||0)),
      act:$("fActive").checked
    };
    if(p.sku.length<3||p.name.length<2){toast("w","Datos incompletos","Revisa SKU y nombre.");return;}
    const dup=st.p.some(x=>x.sku.toLowerCase()===p.sku.toLowerCase() && x.id!==p.id);
    if(dup){toast("bad","SKU duplicado","Ya existe ese SKU.");return;}
    const idx=st.p.findIndex(x=>x.id===p.id);
    if(idx>=0) st.p[idx]=p; else st.p.push(p);
    toast("ok", idx>=0?"Producto actualizado":"Producto creado", p.name);
    closeProd(); renderAll();
  }

  // ====== Config ======
  function openCfg(){
    $("cStore").value=st.cfg.store; $("cClerk").value=st.cfg.clerk;
    $("cfg").classList.add("on");
  }
  function closeCfg(){ $("cfg").classList.remove("on"); }
  function saveCfg(){
    st.cfg.store=$("cStore").value.trim()||"El regalo perfecto, S.A.";
    st.cfg.clerk=$("cClerk").value.trim()||"Caja 1";
    toast("info","Configuraci√≥n guardada","Listo.");
    closeCfg(); renderAll();
  }

  // ====== CSV ======
  function csv(filename, rows){
    const esc=s=>{s=String(s??""); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s};
    const txt=rows.map(r=>r.map(esc).join(",")).join("\n");
    const blob=new Blob(["\uFEFF"+txt],{type:"text/csv;charset=utf-8;"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function exportInv(){
    csv("inventario_productos.csv",[
      ["sku","nombre","categoria","costo","precio","stock","reorden","activo"],
      ...st.p.map(p=>[p.sku,p.name,p.cat,p.cost,p.price,p.stock,p.re,p.act?"SI":"NO"])
    ]);
  }
  function exportToday(){
    const key=todayKey(), start=new Date(key).getTime(), end=start+86400000-1;
    const list=st.s.filter(x=>x.at>=start && x.at<=end);
    csv(`ventas_hoy_${key}.csv`,[
      ["id","fecha","cajero","metodo","total","utilidad"],
      ...list.map(x=>[x.id,dt(x.at),x.clerk,x.method,x.sub,x.prof])
    ]);
  }
  function exportRange(){
    const fromV=$("from").value||"inicio", toV=$("to").value||"fin";
    const f=$("from").value ? new Date($("from").value).getTime() : null;
    const t=$("to").value ? (new Date($("to").value).getTime()+86400000-1) : null;
    const list=st.s.filter(x=>{
      if(f!=null && x.at<f) return false;
      if(t!=null && x.at>t) return false;
      return true;
    });
    csv(`ventas_${fromV}_${toV}.csv`,[
      ["id","fecha","cajero","metodo","total","utilidad"],
      ...list.map(x=>[x.id,dt(x.at),x.clerk,x.method,x.sub,x.prof])
    ]);
  }

  // ====== Wiring ======
  $("posQ").oninput=e=>{st.q=e.target.value; renderProducts();};
  $("focusBtn").onclick=()=>$("posQ").focus();
  $("payCash").onclick=()=>{st.pm="cash"; renderCart();};
  $("payCard").onclick=()=>{st.pm="card"; renderCart();};
  $("cashGiven").oninput=()=>renderCart();
  $("clearBtn").onclick=clearCart;
  $("checkoutBtn").onclick=checkout;

  $("invQ").oninput=renderInv;
  $("invF").onchange=renderInv;
  $("newBtn").onclick=()=>openProd(null);

  $("mClose").onclick=closeProd; $("mX").onclick=closeProd; $("mCancel").onclick=closeProd; $("mSave").onclick=saveProd;
  $("cfgBtn").onclick=openCfg; $("cClose").onclick=closeCfg; $("cX").onclick=closeCfg; $("cCancel").onclick=closeCfg; $("cSave").onclick=saveCfg;

  $("invCsvBtn").onclick=exportInv;
  $("todayCsvBtn").onclick=exportToday;
  $("rangeCsvBtn").onclick=exportRange;
  $("from").onchange=renderRep; $("to").onchange=renderRep;

  $("resetBtn").onclick=()=>{
    st.p=JSON.parse(JSON.stringify(demo)); st.s=[]; clearCart();
    toast("info","Restablecido","Se cargaron productos de ejemplo."); renderAll();
  };

  // shortcuts
  window.addEventListener("keydown", (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="k"){e.preventDefault(); $("posQ").focus();}
    if((e.ctrlKey||e.metaKey) && e.key==="Enter"){e.preventDefault(); checkout();}
  });

  // init
  load(); setTab("pos"); renderAll();
</script>
</body>
</html>
